<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DBD Donation Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f0f;
      --bg-elevated: #1a1a1a;
      --bg-card: #222;
      --border: #333;
      --border-light: #444;
      --text: #f0f0f0;
      --text-secondary: #999;
      --text-muted: #666;
      --accent: #8b5cf6;
      --accent-dim: rgba(139, 92, 246, 0.15);
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
      --yellow: #eab308;
    }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-icon {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .brand h1 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .brand span {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 0.5rem;
      font-weight: 400;
    }

    .stats {
      display: flex;
      gap: 2rem;
    }

    .stat {
      text-align: right;
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 1rem;
      align-items: end;
      flex-wrap: wrap;
      padding: 1.25rem;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .field.grow { flex: 1; min-width: 200px; }

    .field label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    input, select {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      padding: 0.6rem 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    select { cursor: pointer; }
    select option { background: var(--bg); }

    .btn {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 0.6rem 1.25rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--bg-card);
      color: var(--text);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-primary.connected {
      background: var(--green);
    }

    .status-block {
      margin-left: auto;
      padding-left: 1rem;
      border-left: 1px solid var(--border);
      min-width: 160px;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.connected { background: var(--green); }
    .status-dot.connecting { background: var(--yellow); animation: pulse 1s infinite; }
    .status-dot.error { background: var(--red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .api-status {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .api-status.set { color: var(--green); }
    .api-status.missing { color: var(--yellow); }

    /* Debug */
    .debug {
      padding: 1rem 1.25rem;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .debug-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.6rem;
    }

    .debug-row {
      display: flex;
      gap: 0.75rem;
    }

    .debug-row input { flex: 1; }

    .debug-result {
      margin-top: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-secondary);
      min-height: 1.2rem;
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 800px) {
      .grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 1rem; }
      .stats { justify-content: center; }
    }

    /* Panel */
    .panel {
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-title svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .panel-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 0.2rem 0.6rem;
      background: var(--bg);
      border-radius: 4px;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      max-height: 420px;
    }

    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-track { background: transparent; }
    .panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Empty */
    .empty {
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Donation */
    .donation {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .donation:hover { background: var(--bg-card); }

    .donation-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .donor {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .donor-name {
      font-weight: 600;
      color: var(--accent);
    }

    .amount {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--green);
      padding: 0.15rem 0.4rem;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 4px;
    }

    .time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .message {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.6rem;
    }

    .character {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .badge.survivor { background: var(--blue); color: white; }
    .badge.killer { background: var(--red); color: white; }
    .badge.unknown { background: var(--text-muted); color: var(--bg); }

    .char-name { font-weight: 600; }
    .char-name.identifying { color: var(--text-muted); font-style: italic; }

    /* Chat */
    .chat-body { padding: 0.75rem 1rem; }

    .chat-msg {
      padding: 0.3rem 0;
      font-size: 0.85rem;
    }

    .chat-msg.livepix {
      background: var(--accent-dim);
      margin: 0.2rem -1rem;
      padding: 0.3rem 1rem;
      border-left: 2px solid var(--accent);
    }

    .chat-user {
      font-weight: 600;
      margin-right: 0.4rem;
    }

    .chat-user.livepix { color: var(--accent); }
    .chat-user.regular { color: var(--blue); }

    .chat-text { color: var(--text-secondary); }

    /* Footer */
    .footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="brand-icon">⛧</div>
        <h1>DBD Tracker<span>Character Requests</span></h1>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="totalDonations">0</div>
          <div class="stat-label">Donations</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="survivorCount">0</div>
          <div class="stat-label">Survivors</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="killerCount">0</div>
          <div class="stat-label">Killers</div>
        </div>
      </div>
    </header>

    <section class="controls">
      <div class="field grow">
        <label>Twitch Channel</label>
        <input type="text" id="channelInput" value="mandymess" placeholder="channel">
      </div>
      <div class="field">
        <label>LLM Provider</label>
        <select id="llmProvider" onchange="updateApiStatus()">
          <option value="gemini">Gemini</option>
          <option value="anthropic">Anthropic</option>
        </select>
      </div>
      <button class="btn btn-ghost" onclick="setApiKey()">API Key</button>
      <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">Connect</button>
      <div class="status-block">
        <div class="status-row">
          <span class="status-dot" id="statusDot"></span>
          <span id="status">Disconnected</span>
        </div>
        <div class="api-status" id="apiStatus"></div>
      </div>
    </section>

    <section class="debug">
      <div class="debug-label">Debug LLM</div>
      <div class="debug-row">
        <input type="text" id="debugInput" placeholder="Test character extraction...">
        <button class="btn btn-ghost" onclick="testExtraction()">Test</button>
      </div>
      <div class="debug-result" id="debugResult"></div>
    </section>

    <main class="grid">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v6a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h6"/><path d="M12 12l9-9M15 3h6v6"/></svg>
            Character Requests
          </div>
          <span class="panel-count" id="count">0</span>
        </div>
        <div class="panel-body" id="donations">
          <div class="empty">Waiting for donations...</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
            Live Chat
          </div>
        </div>
        <div class="panel-body chat-body" id="chatlog">
          <div class="empty">Chat messages will appear here...</div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div>Watching <strong style="color: var(--accent)">livepix</strong> donations</div>
      <div>API: <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div>
    </footer>
  </div>

  <script>
    const DBD_CHARACTERS = {
      survivors: ["Dwight Fairfield", "Meg Thomas", "Claudette Morel", "Jake Park", "Nea Karlsson", "Laurie Strode", "Ace Visconti", "Bill Overbeck", "Feng Min", "David King", "Quentin Smith", "David Tapp", "Kate Denson", "Adam Francis", "Jeff Johansen", "Jane Romero", "Ash Williams", "Nancy Wheeler", "Steve Harrington", "Yui Kimura", "Zarina Kassir", "Cheryl Mason", "Felix Richter", "Élodie Rakoto", "Yun-Jin Lee", "Jill Valentine", "Leon S. Kennedy", "Mikaela Reid", "Jonah Vasquez", "Yoichi Asakawa", "Haddie Kaur", "Ada Wong", "Rebecca Chambers", "Vittorio Toscano", "Thalita Lyra", "Renato Lyra", "Gabriel Soma", "Nicolas Cage", "Ellen Ripley", "Alan Wake", "Sable Ward", "Aestri Yazar", "Lara Croft", "Trevor Belmont", "Sydney Prescott"],
      killers: ["Trapper", "Wraith", "Hillbilly", "Nurse", "Shape", "Hag", "Doctor", "Huntress", "Cannibal", "Nightmare", "Pig", "Clown", "Spirit", "Legion", "Plague", "Ghost Face", "Demogorgon", "Oni", "Deathslinger", "Pyramid Head", "Blight", "Twins", "Trickster", "Nemesis", "Cenobite", "Artist", "Onryō", "Dredge", "Mastermind", "Knight", "Skull Merchant", "Singularity", "Xenomorph", "Good Guy", "Unknown", "Lich", "Dark Lord", "Houndmaster", "Dracula"]
    };

    let ws = null;
    let donations = [];

    function getProvider() { return document.getElementById('llmProvider').value; }
    function getApiKey() { return localStorage.getItem(`${getProvider()}_key`); }

    function setApiKey() {
      const provider = getProvider();
      const key = prompt(`Enter your ${provider === 'gemini' ? 'Gemini' : 'Anthropic'} API key:`);
      if (key) { localStorage.setItem(`${provider}_key`, key); updateApiStatus(); }
    }

    function updateApiStatus() {
      const key = getApiKey();
      const el = document.getElementById('apiStatus');
      el.className = key ? 'api-status set' : 'api-status missing';
      el.textContent = key ? `✓ ${getProvider()} configured` : `⚠ No API key`;
    }

    function setStatus(text, state = 'disconnected') {
      const dot = document.getElementById('statusDot');
      const btn = document.getElementById('connectBtn');
      dot.className = 'status-dot ' + state;
      btn.classList.toggle('connected', state === 'connected');
      document.getElementById('status').textContent = text;
    }

    function toggleConnection() {
      if (ws) { ws.close(); ws = null; document.getElementById('connectBtn').textContent = 'Connect'; setStatus('Disconnected'); }
      else { connect(); }
    }

    function connect() {
      const channel = document.getElementById('channelInput').value.trim().toLowerCase();
      if (!channel) return;
      setStatus('Connecting...', 'connecting');
      document.getElementById('connectBtn').textContent = 'Disconnect';
      ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
      ws.onopen = () => {
        ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
        ws.send('NICK justinfan' + Math.floor(Math.random() * 99999));
        ws.send(`JOIN #${channel}`);
      };
      ws.onmessage = (event) => {
        for (const line of event.data.split('\r\n')) {
          if (line.startsWith('PING')) ws.send('PONG :tmi.twitch.tv');
          else if (line.includes('366')) setStatus(`#${channel}`, 'connected');
          else if (line.includes('PRIVMSG')) handleMessage(line);
        }
      };
      ws.onclose = () => { setStatus('Disconnected', 'error'); document.getElementById('connectBtn').textContent = 'Connect'; ws = null; };
      ws.onerror = () => setStatus('Error', 'error');
    }

    function handleMessage(raw) {
      const userMatch = raw.match(/display-name=([^;]*)/i);
      const msgMatch = raw.match(/PRIVMSG #\w+ :(.+)$/);
      if (!userMatch || !msgMatch) return;
      const displayName = userMatch[1] || 'unknown';
      const username = displayName.toLowerCase();
      const message = msgMatch[1].trim();
      addToChatLog(displayName, message, username === 'livepix');
      if (username !== 'livepix') return;
      const match = message.match(/^(.+?)\s+(?:doou|mandou)\s+(R\$\s?[\d,\.]+)(?::\s*|\s+e disse:\s*)(.*)$/i);
      if (!match) return;
      const donation = { id: Date.now(), timestamp: new Date(), donor: match[1].trim(), amount: match[2], message: match[3].trim(), character: 'Identifying...', type: 'unknown' };
      donations.unshift(donation);
      renderDonations();
      identifyCharacter(donation);
    }

    function addToChatLog(user, message, isLivepix) {
      const chatlog = document.getElementById('chatlog');
      if (chatlog.querySelector('.empty')) chatlog.innerHTML = '';
      const div = document.createElement('div');
      div.className = `chat-msg${isLivepix ? ' livepix' : ''}`;
      div.innerHTML = `<span class="chat-user ${isLivepix ? 'livepix' : 'regular'}">${user}:</span><span class="chat-text">${message}</span>`;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
      while (chatlog.children.length > 100) chatlog.removeChild(chatlog.firstChild);
    }

    async function callLLM(message) {
      const provider = getProvider();
      const apiKey = getApiKey();
      if (!apiKey) return { character: 'No API key', type: 'unknown' };
      const systemPrompt = `Identify Dead by Daylight characters from user messages.\nSurvivors: ${DBD_CHARACTERS.survivors.join(', ')}\nKillers: ${DBD_CHARACTERS.killers.join(', ')}\nReply ONLY with JSON: {"character":"Name","type":"survivor"|"killer"|"unknown"}\nIf no character mentioned or unclear, use {"character":"unknown","type":"unknown"}`;
      const userPrompt = `Identify the character from: "${message}"`;
      try {
        let text = '';
        if (provider === 'gemini') {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: `${systemPrompt}\n\n${userPrompt}` }] }], generationConfig: { maxOutputTokens: 100 } })
          });
          if (!response.ok) return { character: `API error`, type: 'unknown' };
          const data = await response.json();
          text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        } else {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
            body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 100, system: systemPrompt, messages: [{ role: 'user', content: userPrompt }] })
          });
          if (!response.ok) return { character: `API error`, type: 'unknown' };
          const data = await response.json();
          text = data.content?.[0]?.text || '';
        }
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) return JSON.parse(jsonMatch[0]);
      } catch (e) { return { character: 'Error', type: 'unknown' }; }
      return { character: 'Unknown', type: 'unknown' };
    }

    async function identifyCharacter(donation) {
      const result = await callLLM(donation.message);
      donation.character = result.character || 'Unknown';
      donation.type = result.type || 'unknown';
      renderDonations();
    }

    async function testExtraction() {
      const input = document.getElementById('debugInput').value.trim();
      const resultDiv = document.getElementById('debugResult');
      if (!input) return;
      resultDiv.innerHTML = 'Identifying...';
      const result = await callLLM(input);
      const color = result.type === 'survivor' ? 'var(--blue)' : result.type === 'killer' ? 'var(--red)' : 'var(--text-muted)';
      resultDiv.innerHTML = `<span style="color:${color}">${result.type}</span> → <strong>${result.character}</strong>`;
    }

    function updateStats() {
      document.getElementById('totalDonations').textContent = donations.length;
      document.getElementById('survivorCount').textContent = donations.filter(d => d.type === 'survivor').length;
      document.getElementById('killerCount').textContent = donations.filter(d => d.type === 'killer').length;
    }

    function renderDonations() {
      const container = document.getElementById('donations');
      document.getElementById('count').textContent = donations.length;
      updateStats();
      if (donations.length === 0) { container.innerHTML = '<div class="empty">Waiting for donations...</div>'; return; }
      container.innerHTML = donations.map(d => `
        <div class="donation">
          <div class="donation-top">
            <div class="donor"><span class="donor-name">${d.donor}</span><span class="amount">${d.amount}</span></div>
            <span class="time">${d.timestamp.toLocaleTimeString()}</span>
          </div>
          <p class="message">${d.message}</p>
          <div class="character">
            <span class="badge ${d.type}">${d.type}</span>
            <span class="char-name ${d.character === 'Identifying...' ? 'identifying' : ''}">${d.character}</span>
          </div>
        </div>
      `).join('');
    }

    updateApiStatus();
  </script>
</body>
</html>
