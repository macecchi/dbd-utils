<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DBD Donation Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-void: #0a0a0c;
      --bg-panel: #12121a;
      --bg-card: #1a1a24;
      --bg-hover: #222230;
      --border-dark: #2a2a3a;
      --border-glow: #3a3a4a;
      --text-primary: #e8e8f0;
      --text-secondary: #8888a0;
      --text-muted: #555566;
      --accent-red: #ff2a4a;
      --accent-red-glow: #ff2a4a66;
      --accent-cyan: #00f0ff;
      --accent-cyan-glow: #00f0ff44;
      --accent-purple: #a855f7;
      --accent-green: #22ff88;
      --survivor-blue: #3b82f6;
      --killer-red: #ef4444;
    }

    html { font-size: 14px; }

    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-void);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated fog background */
    .fog-container {
      position: fixed;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }

    .fog {
      position: absolute;
      width: 200%;
      height: 200%;
      background:
        radial-gradient(ellipse at 20% 50%, var(--accent-red-glow) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 50%, var(--accent-cyan-glow) 0%, transparent 50%);
      opacity: 0.3;
      animation: fogDrift 30s ease-in-out infinite;
    }

    @keyframes fogDrift {
      0%, 100% { transform: translate(-10%, -10%) rotate(0deg); }
      50% { transform: translate(0%, 0%) rotate(5deg); }
    }

    /* Scanline overlay */
    .scanlines {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1000;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.1) 2px,
        rgba(0, 0, 0, 0.1) 4px
      );
    }

    /* Main container */
    .app-container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, var(--bg-panel) 0%, var(--bg-card) 100%);
      border: 1px solid var(--border-dark);
      border-left: 3px solid var(--accent-red);
      clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px));
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent-red) 0%, #ff6b4a 100%);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      animation: logoPulse 3s ease-in-out infinite;
    }

    @keyframes logoPulse {
      0%, 100% { filter: brightness(1) drop-shadow(0 0 10px var(--accent-red-glow)); }
      50% { filter: brightness(1.2) drop-shadow(0 0 20px var(--accent-red)); }
    }

    .title-text h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      background: linear-gradient(90deg, var(--text-primary) 0%, var(--accent-cyan) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .title-text span {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.2em;
    }

    .header-stats {
      display: flex;
      gap: 2rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-cyan);
      text-shadow: 0 0 10px var(--accent-cyan-glow);
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    /* Control Panel */
    .control-panel {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      padding: 1.25rem;
      background: var(--bg-panel);
      border: 1px solid var(--border-dark);
      position: relative;
    }

    .control-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-red), var(--accent-cyan));
    }

    .control-grid {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-width: 180px;
    }

    .input-group.wide { flex: 1; min-width: 220px; }

    .input-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .input-label::before {
      content: '›';
      color: var(--accent-cyan);
    }

    input, select {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.9rem;
      padding: 0.65rem 1rem;
      background: var(--bg-void);
      border: 1px solid var(--border-dark);
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 2px var(--accent-cyan-glow), inset 0 0 20px rgba(0, 240, 255, 0.05);
    }

    select { cursor: pointer; }
    select option { background: var(--bg-void); }

    .btn {
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.65rem 1.5rem;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before { left: 100%; }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border-dark);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-glow);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-red) 0%, #ff4060 100%);
      color: white;
      clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);
    }

    .btn-primary:hover {
      filter: brightness(1.1);
      box-shadow: 0 0 20px var(--accent-red-glow);
    }

    .btn-primary.connected {
      background: linear-gradient(135deg, var(--accent-green) 0%, #44ff99 100%);
      box-shadow: 0 0 20px rgba(34, 255, 136, 0.3);
    }

    .status-area {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.25rem;
      padding-left: 1rem;
      border-left: 1px solid var(--border-dark);
    }

    .status-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.connected {
      background: var(--accent-green);
      box-shadow: 0 0 10px var(--accent-green);
      animation: statusPulse 2s ease-in-out infinite;
    }

    .status-dot.connecting {
      background: #fbbf24;
      animation: statusPulse 0.5s ease-in-out infinite;
    }

    .status-dot.error {
      background: var(--accent-red);
    }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .api-status {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .api-status.set { color: var(--accent-green); }
    .api-status.missing { color: #fbbf24; }

    /* Debug Panel */
    .debug-panel {
      padding: 1rem 1.25rem;
      background: var(--bg-panel);
      border: 1px solid var(--border-dark);
      border-left: 3px solid var(--accent-purple);
    }

    .debug-header {
      font-size: 0.7rem;
      color: var(--accent-purple);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .debug-row {
      display: flex;
      gap: 0.75rem;
    }

    .debug-row input {
      flex: 1;
    }

    .btn-test {
      background: linear-gradient(135deg, var(--accent-purple) 0%, #c084fc 100%);
      color: white;
    }

    .btn-test:hover {
      filter: brightness(1.1);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }

    .debug-result {
      margin-top: 0.75rem;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.85rem;
      padding: 0.5rem;
      background: var(--bg-void);
      border-left: 2px solid var(--border-dark);
      min-height: 1.5rem;
    }

    /* Main Content Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      flex: 1;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 1rem; text-align: center; }
      .header-stats { justify-content: center; }
    }

    /* Panel */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-dark);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 1rem 1.25rem;
      background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-panel) 100%);
      border-bottom: 1px solid var(--border-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .panel-title-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .panel-title-icon.donations {
      background: linear-gradient(135deg, var(--accent-red) 0%, #ff6b4a 100%);
      clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
    }

    .panel-title-icon.chat {
      background: linear-gradient(135deg, var(--accent-cyan) 0%, #60f0ff 100%);
      clip-path: polygon(0% 15%, 15% 0%, 85% 0%, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0% 85%);
    }

    .panel-count {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 0.25rem 0.75rem;
      background: var(--bg-void);
      border: 1px solid var(--border-dark);
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      max-height: 450px;
    }

    .panel-body::-webkit-scrollbar {
      width: 6px;
    }

    .panel-body::-webkit-scrollbar-track {
      background: var(--bg-void);
    }

    .panel-body::-webkit-scrollbar-thumb {
      background: var(--border-glow);
      border-radius: 3px;
    }

    .panel-body::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
    }

    .empty-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .empty-text {
      font-size: 0.85rem;
      letter-spacing: 0.1em;
    }

    /* Donation Item */
    .donation-item {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-dark);
      transition: all 0.2s;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .donation-item:hover {
      background: var(--bg-card);
    }

    .donation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .donor-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .donor-name {
      font-weight: 600;
      color: var(--accent-cyan);
    }

    .donation-amount {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.9rem;
      color: var(--accent-green);
      padding: 0.15rem 0.5rem;
      background: rgba(34, 255, 136, 0.1);
      border: 1px solid rgba(34, 255, 136, 0.2);
    }

    .donation-time {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .donation-message {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }

    .donation-character {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .character-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      clip-path: polygon(6px 0, 100% 0, calc(100% - 6px) 100%, 0 100%);
    }

    .character-badge.survivor {
      background: var(--survivor-blue);
      color: white;
    }

    .character-badge.killer {
      background: var(--killer-red);
      color: white;
    }

    .character-badge.unknown {
      background: var(--text-muted);
      color: var(--bg-void);
    }

    .character-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .character-name.identifying {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Chat */
    .chat-body {
      padding: 0.75rem;
    }

    .chat-message {
      padding: 0.35rem 0.5rem;
      font-size: 0.85rem;
      border-radius: 2px;
      margin-bottom: 0.25rem;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .chat-message.livepix {
      background: rgba(168, 85, 247, 0.15);
      border-left: 2px solid var(--accent-purple);
    }

    .chat-user {
      font-weight: 600;
      margin-right: 0.5rem;
    }

    .chat-user.livepix { color: var(--accent-purple); }
    .chat-user.regular { color: var(--accent-cyan); }

    .chat-text {
      color: var(--text-secondary);
    }

    /* Footer */
    .footer {
      padding: 1rem 1.25rem;
      background: var(--bg-panel);
      border: 1px solid var(--border-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--accent-cyan);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .footer-tag {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .footer-tag::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent-purple);
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
    }
  </style>
</head>
<body>
  <div class="fog-container">
    <div class="fog"></div>
  </div>
  <div class="scanlines"></div>

  <div class="app-container">
    <header class="header">
      <div class="header-title">
        <div class="logo-icon">⛧</div>
        <div class="title-text">
          <h1>DBD Tracker</h1>
          <span>Character Request Monitor</span>
        </div>
      </div>
      <div class="header-stats">
        <div class="stat-item">
          <div class="stat-value" id="totalDonations">0</div>
          <div class="stat-label">Donations</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="survivorCount">0</div>
          <div class="stat-label">Survivors</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="killerCount">0</div>
          <div class="stat-label">Killers</div>
        </div>
      </div>
    </header>

    <section class="control-panel">
      <div class="control-grid">
        <div class="input-group wide">
          <label class="input-label">Twitch Channel</label>
          <input type="text" id="channelInput" value="mandymess" placeholder="channel name">
        </div>
        <div class="input-group">
          <label class="input-label">LLM Provider</label>
          <select id="llmProvider" onchange="updateApiStatus()">
            <option value="gemini">Gemini</option>
            <option value="anthropic">Anthropic</option>
          </select>
        </div>
        <button class="btn btn-secondary" onclick="setApiKey()">Set API Key</button>
        <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">Connect</button>
      </div>
      <div class="status-area">
        <div class="status-text">
          <span class="status-dot" id="statusDot"></span>
          <span id="status">Disconnected</span>
        </div>
        <div class="api-status" id="apiStatus"></div>
      </div>
    </section>

    <section class="debug-panel">
      <div class="debug-header">
        <span>◈</span> Debug LLM Extraction
      </div>
      <div class="debug-row">
        <input type="text" id="debugInput" placeholder="e.g. 'quero jogar de nurse' or paste full message">
        <button class="btn btn-test" onclick="testExtraction()">Test</button>
      </div>
      <div class="debug-result" id="debugResult"></div>
    </section>

    <main class="main-grid">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <span class="panel-title-icon donations">⛧</span>
            Character Requests
          </div>
          <span class="panel-count" id="count">0 requests</span>
        </div>
        <div class="panel-body" id="donations">
          <div class="empty-state">
            <div class="empty-icon">⛧</div>
            <div class="empty-text">Waiting for donations...</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <span class="panel-title-icon chat">◉</span>
            Live Chat
          </div>
        </div>
        <div class="panel-body chat-body" id="chatlog">
          <div class="empty-state">
            <div class="empty-icon">◉</div>
            <div class="empty-text">Chat messages will appear here...</div>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-tag">
        Watching for <strong style="color: var(--accent-purple); margin: 0 0.25rem;">livepix</strong> donation messages
      </div>
      <div>
        Gemini API: <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a>
      </div>
    </footer>
  </div>

  <script>
    const DBD_CHARACTERS = {
      survivors: ["Dwight Fairfield", "Meg Thomas", "Claudette Morel", "Jake Park", "Nea Karlsson", "Laurie Strode", "Ace Visconti", "Bill Overbeck", "Feng Min", "David King", "Quentin Smith", "David Tapp", "Kate Denson", "Adam Francis", "Jeff Johansen", "Jane Romero", "Ash Williams", "Nancy Wheeler", "Steve Harrington", "Yui Kimura", "Zarina Kassir", "Cheryl Mason", "Felix Richter", "Élodie Rakoto", "Yun-Jin Lee", "Jill Valentine", "Leon S. Kennedy", "Mikaela Reid", "Jonah Vasquez", "Yoichi Asakawa", "Haddie Kaur", "Ada Wong", "Rebecca Chambers", "Vittorio Toscano", "Thalita Lyra", "Renato Lyra", "Gabriel Soma", "Nicolas Cage", "Ellen Ripley", "Alan Wake", "Sable Ward", "Aestri Yazar", "Lara Croft", "Trevor Belmont", "Sydney Prescott"],
      killers: ["Trapper", "Wraith", "Hillbilly", "Nurse", "Shape", "Hag", "Doctor", "Huntress", "Cannibal", "Nightmare", "Pig", "Clown", "Spirit", "Legion", "Plague", "Ghost Face", "Demogorgon", "Oni", "Deathslinger", "Pyramid Head", "Blight", "Twins", "Trickster", "Nemesis", "Cenobite", "Artist", "Onryō", "Dredge", "Mastermind", "Knight", "Skull Merchant", "Singularity", "Xenomorph", "Good Guy", "Unknown", "Lich", "Dark Lord", "Houndmaster", "Dracula"]
    };

    let ws = null;
    let donations = [];

    function getProvider() {
      return document.getElementById('llmProvider').value;
    }

    function getApiKey() {
      const provider = getProvider();
      return localStorage.getItem(`${provider}_key`);
    }

    function setApiKey() {
      const provider = getProvider();
      const key = prompt(`Enter your ${provider === 'gemini' ? 'Gemini' : 'Anthropic'} API key:`);
      if (key) {
        localStorage.setItem(`${provider}_key`, key);
        updateApiStatus();
      }
    }

    function updateApiStatus() {
      const provider = getProvider();
      const key = getApiKey();
      const statusDiv = document.getElementById('apiStatus');
      if (key) {
        statusDiv.className = 'api-status set';
        statusDiv.textContent = `✓ ${provider} API key configured`;
      } else {
        statusDiv.className = 'api-status missing';
        statusDiv.textContent = `⚠ No ${provider} API key`;
      }
    }

    function setStatus(text, state = 'disconnected') {
      const dot = document.getElementById('statusDot');
      const statusText = document.getElementById('status');
      const btn = document.getElementById('connectBtn');

      dot.className = 'status-dot';
      if (state === 'connected') {
        dot.classList.add('connected');
        btn.classList.add('connected');
      } else if (state === 'connecting') {
        dot.classList.add('connecting');
        btn.classList.remove('connected');
      } else if (state === 'error') {
        dot.classList.add('error');
        btn.classList.remove('connected');
      } else {
        btn.classList.remove('connected');
      }

      statusText.textContent = text;
    }

    function toggleConnection() {
      if (ws) {
        ws.close();
        ws = null;
        document.getElementById('connectBtn').textContent = 'Connect';
        setStatus('Disconnected');
      } else {
        connect();
      }
    }

    function connect() {
      const channel = document.getElementById('channelInput').value.trim().toLowerCase();
      if (!channel) return;

      setStatus('Connecting...', 'connecting');
      document.getElementById('connectBtn').textContent = 'Disconnect';

      ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

      ws.onopen = () => {
        ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
        ws.send('NICK justinfan' + Math.floor(Math.random() * 99999));
        ws.send(`JOIN #${channel}`);
      };

      ws.onmessage = (event) => {
        const lines = event.data.split('\r\n');
        for (const line of lines) {
          if (line.startsWith('PING')) {
            ws.send('PONG :tmi.twitch.tv');
          } else if (line.includes('366')) {
            setStatus(`Connected to #${channel}`, 'connected');
          } else if (line.includes('PRIVMSG')) {
            handleMessage(line);
          }
        }
      };

      ws.onclose = () => {
        setStatus('Disconnected', 'error');
        document.getElementById('connectBtn').textContent = 'Connect';
        ws = null;
      };

      ws.onerror = () => setStatus('Connection error', 'error');
    }

    function handleMessage(raw) {
      const userMatch = raw.match(/display-name=([^;]*)/i);
      const msgMatch = raw.match(/PRIVMSG #\w+ :(.+)$/);

      if (!userMatch || !msgMatch) return;

      const displayName = userMatch[1] || 'unknown';
      const username = displayName.toLowerCase();
      const message = msgMatch[1].trim();

      addToChatLog(displayName, message, username === 'livepix');

      if (username !== 'livepix') return;

      console.log('LivePix donation:', message);

      const match = message.match(/^(.+?)\s+(?:doou|mandou)\s+(R\$\s?[\d,\.]+)(?::\s*|\s+e disse:\s*)(.*)$/i);
      if (!match) {
        console.log('Could not parse donation format');
        return;
      }

      const donation = {
        id: Date.now(),
        timestamp: new Date(),
        donor: match[1].trim(),
        amount: match[2],
        message: match[3].trim(),
        character: 'Identifying...',
        type: 'unknown'
      };

      console.log('Parsed donation:', donation);
      donations.unshift(donation);
      renderDonations();
      identifyCharacter(donation);
    }

    function addToChatLog(user, message, isLivepix) {
      const chatlog = document.getElementById('chatlog');
      if (chatlog.querySelector('.empty-state')) {
        chatlog.innerHTML = '';
      }

      const div = document.createElement('div');
      div.className = `chat-message${isLivepix ? ' livepix' : ''}`;
      div.innerHTML = `<span class="chat-user ${isLivepix ? 'livepix' : 'regular'}">${user}:</span><span class="chat-text">${message}</span>`;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;

      while (chatlog.children.length > 100) {
        chatlog.removeChild(chatlog.firstChild);
      }
    }

    async function callLLM(message) {
      const provider = getProvider();
      const apiKey = getApiKey();

      if (!apiKey) {
        return { character: 'No API key', type: 'unknown' };
      }

      const systemPrompt = `Identify Dead by Daylight characters from user messages.
Survivors: ${DBD_CHARACTERS.survivors.join(', ')}
Killers: ${DBD_CHARACTERS.killers.join(', ')}
Reply ONLY with JSON: {"character":"Name","type":"survivor"|"killer"|"unknown"}
If no character mentioned or unclear, use {"character":"unknown","type":"unknown"}`;

      const userPrompt = `Identify the character from: "${message}"`;

      try {
        if (provider === 'gemini') {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `${systemPrompt}\n\n${userPrompt}` }] }],
              generationConfig: { maxOutputTokens: 100 }
            })
          });

          if (!response.ok) {
            const err = await response.text();
            console.error('Gemini error:', response.status, err);
            return { character: `API error: ${response.status}`, type: 'unknown' };
          }

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          console.log('Gemini response:', text);
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
          }
        } else {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 100,
              system: systemPrompt,
              messages: [{ role: 'user', content: userPrompt }]
            })
          });

          if (!response.ok) {
            const err = await response.text();
            console.error('Anthropic error:', response.status, err);
            return { character: `API error: ${response.status}`, type: 'unknown' };
          }

          const data = await response.json();
          const text = data.content?.[0]?.text || '';
          console.log('Anthropic response:', text);
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
          }
        }
      } catch (e) {
        console.error('LLM error:', e);
        return { character: 'Error: ' + e.message, type: 'unknown' };
      }

      return { character: 'Unknown', type: 'unknown' };
    }

    async function identifyCharacter(donation) {
      const result = await callLLM(donation.message);
      donation.character = result.character || 'Unknown';
      donation.type = result.type || 'unknown';
      renderDonations();
    }

    async function testExtraction() {
      const input = document.getElementById('debugInput').value.trim();
      const resultDiv = document.getElementById('debugResult');

      if (!input) return;

      resultDiv.innerHTML = '<span style="color: var(--text-muted)">Identifying...</span>';

      const result = await callLLM(input);
      const typeColor = result.type === 'survivor' ? 'var(--survivor-blue)' : result.type === 'killer' ? 'var(--killer-red)' : 'var(--text-muted)';
      resultDiv.innerHTML = `<span style="color: ${typeColor}; text-transform: uppercase; font-size: 0.75rem; margin-right: 0.5rem;">${result.type}</span><span style="color: var(--text-primary); font-weight: 600;">${result.character}</span>`;
    }

    function updateStats() {
      const survivors = donations.filter(d => d.type === 'survivor').length;
      const killers = donations.filter(d => d.type === 'killer').length;

      document.getElementById('totalDonations').textContent = donations.length;
      document.getElementById('survivorCount').textContent = survivors;
      document.getElementById('killerCount').textContent = killers;
    }

    function renderDonations() {
      const container = document.getElementById('donations');
      document.getElementById('count').textContent = `${donations.length} request${donations.length !== 1 ? 's' : ''}`;
      updateStats();

      if (donations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⛧</div>
            <div class="empty-text">Waiting for donations...</div>
          </div>
        `;
        return;
      }

      container.innerHTML = donations.map(d => {
        const isIdentifying = d.character === 'Identifying...';
        return `
          <div class="donation-item">
            <div class="donation-header">
              <div class="donor-info">
                <span class="donor-name">${d.donor}</span>
                <span class="donation-amount">${d.amount}</span>
              </div>
              <span class="donation-time">${d.timestamp.toLocaleTimeString()}</span>
            </div>
            <p class="donation-message">${d.message}</p>
            <div class="donation-character">
              <span class="character-badge ${d.type}">${d.type}</span>
              <span class="character-name ${isIdentifying ? 'identifying' : ''}">${d.character}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Initialize
    updateApiStatus();
  </script>
</body>
</html>
