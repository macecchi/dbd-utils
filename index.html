<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DBD Donation Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold text-purple-400 mb-6">üéÆ Dead by Daylight Donation Tracker</h1>
    
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <div class="flex gap-4 items-end flex-wrap">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm text-gray-400 mb-1">Twitch Channel</label>
          <input type="text" id="channelInput" value="mandymess" 
            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500">
        </div>
        <div class="min-w-[150px]">
          <label class="block text-sm text-gray-400 mb-1">LLM Provider</label>
          <select id="llmProvider" onchange="updateApiStatus()"
            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500">
            <option value="gemini">Gemini</option>
            <option value="anthropic">Anthropic</option>
          </select>
        </div>
        <button onclick="setApiKey()"
          class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded font-medium transition">
          Set API Key
        </button>
        <button id="connectBtn" onclick="toggleConnection()"
          class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded font-medium transition">
          Connect
        </button>
      </div>
      <div id="status" class="mt-3 text-sm text-gray-400">Disconnected</div>
      <div id="apiStatus" class="text-sm text-gray-500 mt-1"></div>
    </div>

    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <label class="block text-sm text-gray-400 mb-1">üß™ Debug LLM Extraction</label>
      <div class="flex gap-2">
        <input type="text" id="debugInput" placeholder="e.g. 'quero jogar de nurse' or paste full message"
          class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500">
        <button onclick="testExtraction()"
          class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-medium transition">
          Test
        </button>
      </div>
      <div id="debugResult" class="mt-2 text-sm text-gray-400"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <div class="bg-gray-750 px-4 py-3 border-b border-gray-700 flex justify-between items-center">
          <h2 class="font-semibold">üéÅ Character Requests</h2>
          <span id="count" class="text-sm text-gray-400">0 donations</span>
        </div>
        <div id="donations" class="divide-y divide-gray-700 max-h-[400px] overflow-y-auto">
          <div class="p-8 text-center text-gray-500">Waiting for donations...</div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <div class="bg-gray-750 px-4 py-3 border-b border-gray-700">
          <h2 class="font-semibold">üí¨ Chat Log</h2>
        </div>
        <div id="chatlog" class="p-4 max-h-[400px] overflow-y-auto text-sm space-y-1">
          <div class="text-gray-500">Chat messages will appear here...</div>
        </div>
      </div>
    </div>

    <div class="mt-4 text-sm text-gray-500">
      <p>Watching for <span class="text-purple-400">livepix</span> donation messages in chat</p>
      <p class="mt-1">Gemini API key: <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-400 hover:underline">aistudio.google.com/apikey</a></p>
    </div>
  </div>

  <script>
    const DBD_CHARACTERS = {
      survivors: ["Dwight Fairfield", "Meg Thomas", "Claudette Morel", "Jake Park", "Nea Karlsson", "Laurie Strode", "Ace Visconti", "Bill Overbeck", "Feng Min", "David King", "Quentin Smith", "David Tapp", "Kate Denson", "Adam Francis", "Jeff Johansen", "Jane Romero", "Ash Williams", "Nancy Wheeler", "Steve Harrington", "Yui Kimura", "Zarina Kassir", "Cheryl Mason", "Felix Richter", "√âlodie Rakoto", "Yun-Jin Lee", "Jill Valentine", "Leon S. Kennedy", "Mikaela Reid", "Jonah Vasquez", "Yoichi Asakawa", "Haddie Kaur", "Ada Wong", "Rebecca Chambers", "Vittorio Toscano", "Thalita Lyra", "Renato Lyra", "Gabriel Soma", "Nicolas Cage", "Ellen Ripley", "Alan Wake", "Sable Ward", "Aestri Yazar", "Lara Croft", "Trevor Belmont", "Sydney Prescott"],
      killers: ["Trapper", "Wraith", "Hillbilly", "Nurse", "Shape", "Hag", "Doctor", "Huntress", "Cannibal", "Nightmare", "Pig", "Clown", "Spirit", "Legion", "Plague", "Ghost Face", "Demogorgon", "Oni", "Deathslinger", "Pyramid Head", "Blight", "Twins", "Trickster", "Nemesis", "Cenobite", "Artist", "Onry≈ç", "Dredge", "Mastermind", "Knight", "Skull Merchant", "Singularity", "Xenomorph", "Good Guy", "Unknown", "Lich", "Dark Lord", "Houndmaster", "Dracula"]
    };

    let ws = null;
    let donations = [];

    function getProvider() {
      return document.getElementById('llmProvider').value;
    }

    function getApiKey() {
      const provider = getProvider();
      return localStorage.getItem(`${provider}_key`);
    }

    function setApiKey() {
      const provider = getProvider();
      const key = prompt(`Enter your ${provider === 'gemini' ? 'Gemini' : 'Anthropic'} API key:`);
      if (key) {
        localStorage.setItem(`${provider}_key`, key);
        updateApiStatus();
      }
    }

    function updateApiStatus() {
      const provider = getProvider();
      const key = getApiKey();
      const statusDiv = document.getElementById('apiStatus');
      if (key) {
        statusDiv.innerHTML = `<span class="text-green-400">‚úì ${provider} API key set</span>`;
      } else {
        statusDiv.innerHTML = `<span class="text-yellow-400">‚ö† No ${provider} API key - click "Set API Key"</span>`;
      }
    }

    function setStatus(text, color = 'gray') {
      const colors = { gray: 'text-gray-400', green: 'text-green-400', red: 'text-red-400', yellow: 'text-yellow-400' };
      document.getElementById('status').className = `mt-3 text-sm ${colors[color]}`;
      document.getElementById('status').textContent = text;
    }

    function toggleConnection() {
      if (ws) {
        ws.close();
        ws = null;
        document.getElementById('connectBtn').textContent = 'Connect';
        setStatus('Disconnected');
      } else {
        connect();
      }
    }

    function connect() {
      const channel = document.getElementById('channelInput').value.trim().toLowerCase();
      if (!channel) return;

      setStatus('Connecting...', 'yellow');
      document.getElementById('connectBtn').textContent = 'Disconnect';

      ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

      ws.onopen = () => {
        ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
        ws.send('NICK justinfan' + Math.floor(Math.random() * 99999));
        ws.send(`JOIN #${channel}`);
      };

      ws.onmessage = (event) => {
        const lines = event.data.split('\r\n');
        for (const line of lines) {
          if (line.startsWith('PING')) {
            ws.send('PONG :tmi.twitch.tv');
          } else if (line.includes('366')) {
            setStatus(`Connected to #${channel}`, 'green');
          } else if (line.includes('PRIVMSG')) {
            handleMessage(line);
          }
        }
      };

      ws.onclose = () => {
        setStatus('Disconnected', 'red');
        document.getElementById('connectBtn').textContent = 'Connect';
        ws = null;
      };

      ws.onerror = () => setStatus('Connection error', 'red');
    }

    function handleMessage(raw) {
      const userMatch = raw.match(/display-name=([^;]*)/i);
      const msgMatch = raw.match(/PRIVMSG #\w+ :(.+)$/);
      
      if (!userMatch || !msgMatch) return;
      
      const displayName = userMatch[1] || 'unknown';
      const username = displayName.toLowerCase();
      const message = msgMatch[1].trim();

      addToChatLog(displayName, message, username === 'livepix');

      if (username !== 'livepix') return;

      console.log('LivePix donation:', message);
      
      const match = message.match(/^(.+?)\s+(?:doou|mandou)\s+(R\$\s?[\d,\.]+)(?::\s*|\s+e disse:\s*)(.*)$/i);
      if (!match) {
        console.log('Could not parse donation format');
        return;
      }

      const donation = {
        id: Date.now(),
        timestamp: new Date(),
        donor: match[1].trim(),
        amount: match[2],
        message: match[3].trim(),
        character: 'Identifying...',
        type: 'unknown'
      };

      console.log('Parsed donation:', donation);
      donations.unshift(donation);
      renderDonations();
      identifyCharacter(donation);
    }

    function addToChatLog(user, message, isLivepix) {
      const chatlog = document.getElementById('chatlog');
      if (chatlog.querySelector('.text-gray-500')) {
        chatlog.innerHTML = '';
      }
      
      const div = document.createElement('div');
      div.className = isLivepix ? 'bg-purple-900/30 p-1 rounded' : '';
      div.innerHTML = `<span class="${isLivepix ? 'text-purple-400' : 'text-blue-400'} font-medium">${user}:</span> <span class="text-gray-300">${message}</span>`;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
      
      while (chatlog.children.length > 100) {
        chatlog.removeChild(chatlog.firstChild);
      }
    }

    async function callLLM(message) {
      const provider = getProvider();
      const apiKey = getApiKey();
      
      if (!apiKey) {
        return { character: 'No API key', type: 'unknown' };
      }

      const systemPrompt = `Identify Dead by Daylight characters from user messages. 
Survivors: ${DBD_CHARACTERS.survivors.join(', ')}
Killers: ${DBD_CHARACTERS.killers.join(', ')}
Reply ONLY with JSON: {"character":"Name","type":"survivor"|"killer"|"unknown"}
If no character mentioned or unclear, use {"character":"unknown","type":"unknown"}`;

      const userPrompt = `Identify the character from: "${message}"`;

      try {
        if (provider === 'gemini') {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `${systemPrompt}\n\n${userPrompt}` }] }],
              generationConfig: { maxOutputTokens: 100 }
            })
          });

          if (!response.ok) {
            const err = await response.text();
            console.error('Gemini error:', response.status, err);
            return { character: `API error: ${response.status}`, type: 'unknown' };
          }

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          console.log('Gemini response:', text);
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
          }
        } else {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 100,
              system: systemPrompt,
              messages: [{ role: 'user', content: userPrompt }]
            })
          });

          if (!response.ok) {
            const err = await response.text();
            console.error('Anthropic error:', response.status, err);
            return { character: `API error: ${response.status}`, type: 'unknown' };
          }

          const data = await response.json();
          const text = data.content?.[0]?.text || '';
          console.log('Anthropic response:', text);
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
          }
        }
      } catch (e) {
        console.error('LLM error:', e);
        return { character: 'Error: ' + e.message, type: 'unknown' };
      }

      return { character: 'Unknown', type: 'unknown' };
    }

    async function identifyCharacter(donation) {
      const result = await callLLM(donation.message);
      donation.character = result.character || 'Unknown';
      donation.type = result.type || 'unknown';
      renderDonations();
    }

    async function testExtraction() {
      const input = document.getElementById('debugInput').value.trim();
      const resultDiv = document.getElementById('debugResult');
      
      if (!input) return;
      
      resultDiv.innerHTML = '<span class="text-yellow-400">Identifying...</span>';
      
      const result = await callLLM(input);
      const typeColor = result.type === 'survivor' ? 'text-blue-400' : result.type === 'killer' ? 'text-red-400' : 'text-gray-400';
      resultDiv.innerHTML = `<span class="${typeColor}">${result.type}</span>: <span class="text-white font-medium">${result.character}</span>`;
    }

    function renderDonations() {
      const container = document.getElementById('donations');
      document.getElementById('count').textContent = `${donations.length} donation${donations.length !== 1 ? 's' : ''}`;

      if (donations.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500">Waiting for donations...</div>';
        return;
      }

      container.innerHTML = donations.map(d => {
        const typeColors = {
          survivor: 'bg-blue-600',
          killer: 'bg-red-600',
          unknown: 'bg-gray-600'
        };
        return `
          <div class="p-4 hover:bg-gray-750 transition">
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="font-medium text-purple-400">${d.donor}</span>
                <span class="text-green-400 ml-2">${d.amount}</span>
              </div>
              <span class="text-xs text-gray-500">${d.timestamp.toLocaleTimeString()}</span>
            </div>
            <p class="text-gray-300 text-sm mb-2">${d.message}</p>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded text-xs font-medium ${typeColors[d.type]}">${d.type}</span>
              <span class="font-semibold">${d.character}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Initialize
    updateApiStatus();
  </script>
</body>
</html>
