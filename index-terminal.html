<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DBD Donation Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0a;
      --surface: #111;
      --border: #222;
      --text: #b0b0b0;
      --text-dim: #606060;
      --green: #00ff88;
      --green-dim: rgba(0, 255, 136, 0.1);
      --red: #ff4444;
      --blue: #44aaff;
      --yellow: #ffaa00;
      --purple: #aa66ff;
    }

    body {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Header */
    .header {
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .header-bar {
      background: var(--surface);
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title {
      color: var(--green);
    }

    .title::before { content: '> '; color: var(--text-dim); }

    .stats-row {
      display: flex;
      gap: 2rem;
      font-size: 12px;
    }

    .stat { color: var(--text-dim); }
    .stat strong { color: var(--green); }

    .header-content {
      padding: 0.75rem 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .field label {
      color: var(--text-dim);
      font-size: 11px;
    }

    .field label::after { content: ':'; }

    input, select {
      font-family: inherit;
      font-size: 13px;
      padding: 0.4rem 0.6rem;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--green);
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--green);
    }

    select { cursor: pointer; }
    select option { background: var(--bg); }

    .btn {
      font-family: inherit;
      font-size: 12px;
      padding: 0.4rem 0.8rem;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
    }

    .btn:hover {
      border-color: var(--green);
      color: var(--green);
    }

    .btn-connect {
      border-color: var(--green);
      color: var(--green);
    }

    .btn-connect.connected {
      background: var(--green-dim);
    }

    .status-area {
      margin-left: auto;
      text-align: right;
      font-size: 11px;
    }

    .status-line {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .dot {
      width: 6px;
      height: 6px;
      background: var(--text-dim);
    }

    .dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot.warn { background: var(--yellow); }
    .dot.err { background: var(--red); }

    .api-line {
      color: var(--text-dim);
      font-size: 10px;
    }

    .api-line.ok { color: var(--green); }
    .api-line.missing { color: var(--yellow); }

    /* Debug */
    .debug {
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .debug-bar {
      background: var(--surface);
      padding: 0.4rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      color: var(--purple);
    }

    .debug-bar::before { content: '# '; color: var(--text-dim); }

    .debug-content {
      padding: 0.75rem 1rem;
      display: flex;
      gap: 0.75rem;
    }

    .debug-content input { flex: 1; }

    .debug-result {
      padding: 0 1rem 0.75rem;
      font-size: 12px;
      color: var(--text-dim);
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
    }

    /* Panel */
    .panel {
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .panel-bar {
      background: var(--surface);
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .panel-title { color: var(--green); }
    .panel-title::before { content: '$ '; color: var(--text-dim); }

    .panel-count { color: var(--text-dim); }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
    }

    .panel-body::-webkit-scrollbar { width: 4px; }
    .panel-body::-webkit-scrollbar-track { background: var(--bg); }
    .panel-body::-webkit-scrollbar-thumb { background: var(--border); }

    /* Empty */
    .empty {
      padding: 2rem;
      text-align: center;
      color: var(--text-dim);
      font-size: 12px;
    }

    .empty::before { content: '// '; }

    /* Donation */
    .donation {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .donation:hover { background: var(--surface); }

    .d-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.3rem;
      font-size: 12px;
    }

    .d-user { color: var(--blue); }
    .d-amount { color: var(--green); }
    .d-time { color: var(--text-dim); font-size: 10px; }

    .d-msg {
      color: var(--text);
      margin-bottom: 0.4rem;
      padding-left: 1rem;
      border-left: 2px solid var(--border);
    }

    .d-char {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 12px;
    }

    .tag {
      padding: 0.1rem 0.4rem;
      font-size: 10px;
      text-transform: uppercase;
    }

    .tag.survivor { background: var(--blue); color: #000; }
    .tag.killer { background: var(--red); color: #000; }
    .tag.unknown { background: var(--text-dim); color: #000; }

    .d-char-name { color: var(--text); }
    .d-char-name.loading { color: var(--text-dim); font-style: italic; }

    /* Chat */
    .chat-body { padding: 0.5rem; }

    .c-msg {
      padding: 0.2rem 0.5rem;
      font-size: 12px;
    }

    .c-msg.highlight {
      background: rgba(170, 102, 255, 0.1);
      border-left: 2px solid var(--purple);
      margin-left: -0.5rem;
      padding-left: calc(0.5rem - 2px);
    }

    .c-user { margin-right: 0.5rem; }
    .c-user.lp { color: var(--purple); }
    .c-user.reg { color: var(--blue); }

    .c-text { color: var(--text-dim); }

    /* Footer */
    .footer {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-dim);
    }

    .footer a { color: var(--green); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    .footer strong { color: var(--purple); }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-bar">
        <span class="title">dbd-tracker v1.0</span>
        <div class="stats-row">
          <span class="stat">donations: <strong id="totalDonations">0</strong></span>
          <span class="stat">survivors: <strong id="survivorCount">0</strong></span>
          <span class="stat">killers: <strong id="killerCount">0</strong></span>
        </div>
      </div>
      <div class="header-content">
        <div class="field">
          <label>channel</label>
          <input type="text" id="channelInput" value="mandymess" size="14">
        </div>
        <div class="field">
          <label>llm</label>
          <select id="llmProvider" onchange="updateApiStatus()">
            <option value="gemini">gemini</option>
            <option value="anthropic">anthropic</option>
          </select>
        </div>
        <button class="btn" onclick="setApiKey()">set-key</button>
        <button class="btn btn-connect" id="connectBtn" onclick="toggleConnection()">connect</button>
        <div class="status-area">
          <div class="status-line">
            <span class="dot" id="statusDot"></span>
            <span id="status">offline</span>
          </div>
          <div class="api-line" id="apiStatus"></div>
        </div>
      </div>
    </header>

    <section class="debug">
      <div class="debug-bar">debug llm extraction</div>
      <div class="debug-content">
        <input type="text" id="debugInput" placeholder="test message...">
        <button class="btn" onclick="testExtraction()">run</button>
      </div>
      <div class="debug-result" id="debugResult"></div>
    </section>

    <main class="grid">
      <div class="panel">
        <div class="panel-bar">
          <span class="panel-title">character_requests</span>
          <span class="panel-count">[<span id="count">0</span>]</span>
        </div>
        <div class="panel-body" id="donations">
          <div class="empty">awaiting data...</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-bar">
          <span class="panel-title">live_chat</span>
        </div>
        <div class="panel-body chat-body" id="chatlog">
          <div class="empty">no messages</div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div>watching: <strong>livepix</strong></div>
      <div>api: <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div>
    </footer>
  </div>

  <script>
    const DBD_CHARACTERS = {
      survivors: ["Dwight Fairfield", "Meg Thomas", "Claudette Morel", "Jake Park", "Nea Karlsson", "Laurie Strode", "Ace Visconti", "Bill Overbeck", "Feng Min", "David King", "Quentin Smith", "David Tapp", "Kate Denson", "Adam Francis", "Jeff Johansen", "Jane Romero", "Ash Williams", "Nancy Wheeler", "Steve Harrington", "Yui Kimura", "Zarina Kassir", "Cheryl Mason", "Felix Richter", "Élodie Rakoto", "Yun-Jin Lee", "Jill Valentine", "Leon S. Kennedy", "Mikaela Reid", "Jonah Vasquez", "Yoichi Asakawa", "Haddie Kaur", "Ada Wong", "Rebecca Chambers", "Vittorio Toscano", "Thalita Lyra", "Renato Lyra", "Gabriel Soma", "Nicolas Cage", "Ellen Ripley", "Alan Wake", "Sable Ward", "Aestri Yazar", "Lara Croft", "Trevor Belmont", "Sydney Prescott"],
      killers: ["Trapper", "Wraith", "Hillbilly", "Nurse", "Shape", "Hag", "Doctor", "Huntress", "Cannibal", "Nightmare", "Pig", "Clown", "Spirit", "Legion", "Plague", "Ghost Face", "Demogorgon", "Oni", "Deathslinger", "Pyramid Head", "Blight", "Twins", "Trickster", "Nemesis", "Cenobite", "Artist", "Onryō", "Dredge", "Mastermind", "Knight", "Skull Merchant", "Singularity", "Xenomorph", "Good Guy", "Unknown", "Lich", "Dark Lord", "Houndmaster", "Dracula"]
    };

    let ws = null, donations = [];

    function getProvider() { return document.getElementById('llmProvider').value; }
    function getApiKey() { return localStorage.getItem(`${getProvider()}_key`); }

    function setApiKey() {
      const key = prompt(`enter ${getProvider()} api key:`);
      if (key) { localStorage.setItem(`${getProvider()}_key`, key); updateApiStatus(); }
    }

    function updateApiStatus() {
      const key = getApiKey();
      const el = document.getElementById('apiStatus');
      el.className = key ? 'api-line ok' : 'api-line missing';
      el.textContent = key ? `[${getProvider()}:ok]` : `[${getProvider()}:missing]`;
    }

    function setStatus(text, state = 'off') {
      const dot = document.getElementById('statusDot');
      const btn = document.getElementById('connectBtn');
      dot.className = 'dot';
      if (state === 'on') dot.classList.add('on');
      else if (state === 'warn') dot.classList.add('warn');
      else if (state === 'err') dot.classList.add('err');
      btn.classList.toggle('connected', state === 'on');
      document.getElementById('status').textContent = text;
    }

    function toggleConnection() {
      if (ws) { ws.close(); ws = null; document.getElementById('connectBtn').textContent = 'connect'; setStatus('offline'); }
      else { connect(); }
    }

    function connect() {
      const channel = document.getElementById('channelInput').value.trim().toLowerCase();
      if (!channel) return;
      setStatus('connecting...', 'warn');
      document.getElementById('connectBtn').textContent = 'disconnect';
      ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
      ws.onopen = () => {
        ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
        ws.send('NICK justinfan' + Math.floor(Math.random() * 99999));
        ws.send(`JOIN #${channel}`);
      };
      ws.onmessage = (event) => {
        for (const line of event.data.split('\r\n')) {
          if (line.startsWith('PING')) ws.send('PONG :tmi.twitch.tv');
          else if (line.includes('366')) setStatus(`#${channel}`, 'on');
          else if (line.includes('PRIVMSG')) handleMessage(line);
        }
      };
      ws.onclose = () => { setStatus('offline', 'err'); document.getElementById('connectBtn').textContent = 'connect'; ws = null; };
      ws.onerror = () => setStatus('error', 'err');
    }

    function handleMessage(raw) {
      const userMatch = raw.match(/display-name=([^;]*)/i);
      const msgMatch = raw.match(/PRIVMSG #\w+ :(.+)$/);
      if (!userMatch || !msgMatch) return;
      const displayName = userMatch[1] || 'unknown';
      const username = displayName.toLowerCase();
      const message = msgMatch[1].trim();
      addToChatLog(displayName, message, username === 'livepix');
      if (username !== 'livepix') return;
      const match = message.match(/^(.+?)\s+(?:doou|mandou)\s+(R\$\s?[\d,\.]+)(?::\s*|\s+e disse:\s*)(.*)$/i);
      if (!match) return;
      const donation = { id: Date.now(), timestamp: new Date(), donor: match[1].trim(), amount: match[2], message: match[3].trim(), character: 'identifying...', type: 'unknown' };
      donations.unshift(donation);
      renderDonations();
      identifyCharacter(donation);
    }

    function addToChatLog(user, message, isLivepix) {
      const chatlog = document.getElementById('chatlog');
      if (chatlog.querySelector('.empty')) chatlog.innerHTML = '';
      const div = document.createElement('div');
      div.className = `c-msg${isLivepix ? ' highlight' : ''}`;
      div.innerHTML = `<span class="c-user ${isLivepix ? 'lp' : 'reg'}">${user}:</span><span class="c-text">${message}</span>`;
      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
      while (chatlog.children.length > 100) chatlog.removeChild(chatlog.firstChild);
    }

    async function callLLM(message) {
      const provider = getProvider();
      const apiKey = getApiKey();
      if (!apiKey) return { character: 'no_api_key', type: 'unknown' };
      const systemPrompt = `Identify Dead by Daylight characters from user messages.\nSurvivors: ${DBD_CHARACTERS.survivors.join(', ')}\nKillers: ${DBD_CHARACTERS.killers.join(', ')}\nReply ONLY with JSON: {"character":"Name","type":"survivor"|"killer"|"unknown"}\nIf no character mentioned or unclear, use {"character":"unknown","type":"unknown"}`;
      const userPrompt = `Identify the character from: "${message}"`;
      try {
        let text = '';
        if (provider === 'gemini') {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: `${systemPrompt}\n\n${userPrompt}` }] }], generationConfig: { maxOutputTokens: 100 } })
          });
          if (!response.ok) return { character: 'api_error', type: 'unknown' };
          const data = await response.json();
          text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        } else {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
            body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 100, system: systemPrompt, messages: [{ role: 'user', content: userPrompt }] })
          });
          if (!response.ok) return { character: 'api_error', type: 'unknown' };
          const data = await response.json();
          text = data.content?.[0]?.text || '';
        }
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) return JSON.parse(jsonMatch[0]);
      } catch (e) { return { character: 'error', type: 'unknown' }; }
      return { character: 'unknown', type: 'unknown' };
    }

    async function identifyCharacter(donation) {
      const result = await callLLM(donation.message);
      donation.character = result.character || 'unknown';
      donation.type = result.type || 'unknown';
      renderDonations();
    }

    async function testExtraction() {
      const input = document.getElementById('debugInput').value.trim();
      const resultDiv = document.getElementById('debugResult');
      if (!input) return;
      resultDiv.textContent = '> processing...';
      const result = await callLLM(input);
      resultDiv.innerHTML = `> type: ${result.type} | char: ${result.character}`;
    }

    function updateStats() {
      document.getElementById('totalDonations').textContent = donations.length;
      document.getElementById('survivorCount').textContent = donations.filter(d => d.type === 'survivor').length;
      document.getElementById('killerCount').textContent = donations.filter(d => d.type === 'killer').length;
    }

    function renderDonations() {
      const container = document.getElementById('donations');
      document.getElementById('count').textContent = donations.length;
      updateStats();
      if (donations.length === 0) { container.innerHTML = '<div class="empty">awaiting data...</div>'; return; }
      container.innerHTML = donations.map(d => `
        <div class="donation">
          <div class="d-line">
            <span><span class="d-user">${d.donor}</span> <span class="d-amount">${d.amount}</span></span>
            <span class="d-time">${d.timestamp.toLocaleTimeString()}</span>
          </div>
          <p class="d-msg">${d.message}</p>
          <div class="d-char">
            <span class="tag ${d.type}">${d.type}</span>
            <span class="d-char-name ${d.character === 'identifying...' ? 'loading' : ''}">${d.character}</span>
          </div>
        </div>
      `).join('');
    }

    updateApiStatus();
  </script>
</body>
</html>
